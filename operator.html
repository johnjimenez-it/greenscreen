<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Operator Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    :root {
      color-scheme: dark;
      --surface-100: #0f172a;
      --surface-200: #111c32;
      --surface-300: #15213a;
      --surface-400: #1e293b;
      --primary: #38bdf8;
      --primary-contrast: #04111f;
      --success: #22c55e;
      --success-contrast: #032313;
      --text-primary: #f8fbff;
      --text-secondary: #cbd5f5;
      --border-subtle: rgba(148, 163, 184, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.15), transparent 55%), var(--surface-100);
      color: var(--text-primary);
      font-family: "Inter", "Segoe UI", sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 3rem 1.5rem;
      overflow-y: auto;
    }

    main {
      width: min(1100px, 100%);
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 28px;
      padding: 2.5rem clamp(1.5rem, 4vw, 3rem);
      box-shadow: 0 30px 70px rgba(5, 10, 25, 0.45);
      display: grid;
      gap: 2rem;
    }

    h2 {
      margin: 0;
      font-size: clamp(1.75rem, 2vw, 2.25rem);
      letter-spacing: 0.02em;
    }

    .panel-header {
      display: grid;
      gap: 1.5rem;
    }

    .auth-panel {
      display: grid;
      gap: 0.75rem;
      text-align: center;
      justify-items: center;
    }

    .auth-panel label {
      font-size: 0.95rem;
      color: var(--text-secondary);
      letter-spacing: 0.02em;
    }

    .auth-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
      align-items: center;
    }

    input[type="password"],
    input[type="date"],
    textarea {
      background: var(--surface-300);
      border: 1px solid var(--border-subtle);
      border-radius: 14px;
      color: var(--text-primary);
      font: inherit;
      padding: 0.65rem 1rem;
      min-width: 200px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="password"]:focus,
    input[type="date"]:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.25);
    }

    .btn {
      border: none;
      border-radius: 999px;
      font: inherit;
      font-weight: 600;
      padding: 0.6rem 1.3rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
      text-decoration: none;
    }

    .btn:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 3px;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--primary-contrast);
      box-shadow: 0 10px 25px rgba(56, 189, 248, 0.35);
    }

    .btn-secondary {
      background: var(--surface-400);
      color: var(--text-primary);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.55);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 28px rgba(8, 20, 35, 0.28);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
      gap: 0.75rem;
      background: rgba(17, 28, 50, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 18px;
      padding: 0.75rem 1rem;
    }

    .filters span,
    .filters label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: rgba(12, 19, 34, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 20px;
      overflow: hidden;
    }

    thead th {
      background: rgba(12, 26, 48, 0.95);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-align: left;
    }

    th,
    td {
      padding: 0.85rem 1rem;
      vertical-align: middle;
    }

    tbody tr {
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
      transition: background 0.2s ease;
    }

    tbody tr:last-child {
      border-bottom: none;
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.55);
    }

    tbody tr:nth-child(even) {
      background: rgba(17, 30, 54, 0.6);
    }

    tbody tr:hover {
      background: rgba(56, 189, 248, 0.12);
    }

    tbody td {
      font-size: 0.9rem;
    }

    th:nth-child(1),
    td:nth-child(1),
    th:nth-child(2),
    td:nth-child(2),
    th:nth-child(6),
    td:nth-child(6) {
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    .status-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .btn-status {
      background: rgba(30, 41, 59, 0.9);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding-inline: 0.95rem;
      font-size: 0.8rem;
    }

    .btn-status.is-complete {
      background: var(--success);
      color: var(--success-contrast);
      border-color: rgba(34, 197, 94, 0.75);
    }

    .details-btn {
      font-size: 0.85rem;
    }

    #dashboard {
      display: grid;
      gap: 1.5rem;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(10, 18, 34, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .modal-backdrop.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .modal {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 24px;
      max-width: 640px;
      width: 100%;
      padding: 2.25rem;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.45);
      position: relative;
      color: var(--text-primary);
      display: grid;
      gap: 1.5rem;
    }

    .modal h3 {
      margin: 0;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      color: #94a3b8;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .modal-section {
      display: grid;
      gap: 0.75rem;
    }

    .modal-progress {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.6rem;
    }

    .modal-progress li {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: rgba(148, 163, 184, 0.12);
      padding: 0.65rem 0.85rem;
      border-radius: 12px;
    }

    .modal-progress li .status-indicator {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid #f97316;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .modal-progress li.completed {
      background: rgba(34, 197, 94, 0.18);
    }

    .modal-progress li.completed .status-indicator {
      background: #22c55e;
      border-color: #22c55e;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
    }

    .notes-area .btn {
      justify-self: start;
    }

    .selfie-preview {
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.65);
      border-radius: 16px;
      border: 1px dashed rgba(148, 163, 184, 0.35);
      padding: 1rem;
      min-height: 180px;
    }

    .selfie-preview img {
      max-width: 220px;
      border-radius: 16px;
      border: 4px solid rgba(56, 189, 248, 0.35);
    }

    .selfie-preview p {
      color: #94a3b8;
      margin: 0;
    }

    .modal-section .price-breakdown {
      border-top: 1px solid rgba(148, 163, 184, 0.35);
      padding-top: 0.65rem;
    }

    .modal-section .price-breakdown-label {
      color: var(--text-secondary);
      font-size: 0.95rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .modal-section .price-breakdown-line {
      color: var(--text-secondary);
    }

    .modal-section .price-breakdown-line.total {
      border-top-color: rgba(148, 163, 184, 0.35);
      color: var(--text-primary);
    }

    .modal-section .price-breakdown-detail {
      color: rgba(203, 213, 225, 0.8);
      font-weight: 500;
    }

    .modal-section .price-breakdown-amount {
      color: var(--text-primary);
    }

    .price-breakdown-empty {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    @media (max-width: 720px) {
      main {
        padding: 2rem 1.25rem;
      }

      .filters {
        justify-content: center;
      }

      table {
        font-size: 0.85rem;
      }

      th,
      td {
        padding: 0.75rem 0.75rem;
      }
    }
  </style>
</head>
<body>
  <main>
    <h2>Operator Panel</h2>
    <div class="panel-header">
      <div class="auth-panel">
        <label for="pin">Enter Operator PIN</label>
        <div class="auth-actions">
          <input type="password" id="pin" placeholder="Enter PIN" />
          <button id="loginBtn" class="btn btn-primary">Login</button>
          <button id="exportCsv" class="btn btn-secondary" style="display:none;">Export CSV</button>
        </div>
      </div>
      <div id="dateFilters" class="filters" style="display:none;">
        <span>Filter by date:</span>
        <label for="startDate">From</label>
        <input type="date" id="startDate" name="startDate" />
        <label for="endDate">To</label>
        <input type="date" id="endDate" name="endDate" />
        <button type="button" id="clearDateFilters" class="btn btn-ghost" disabled>Clear</button>
      </div>
    </div>

    <div id="dashboard" style="display:none;">
      <table id="recordsTable">
        <thead>
          <tr>
            <th>Customer #</th>
            <th>Date</th>
            <th>Name</th>
            <th>Payment</th>
            <th>Emails</th>
            <th>Prints</th>
            <th>Photo ID</th>
            <th>Status</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="receiptModal" class="modal-backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <button id="modalClose" class="modal-close" aria-label="Close receipt details">&times;</button>
        <h3 id="modalTitle">Receipt Details</h3>
        <div class="modal-section">
          <h4>Status Progress</h4>
          <ol id="modalProgress" class="modal-progress"></ol>
        </div>
        <div class="modal-section" id="modalPricingSection">
          <h4>Pricing</h4>
          <div id="modalPricing"></div>
        </div>
        <div class="modal-section notes-area">
          <h4>Notes</h4>
          <textarea id="modalNotes" placeholder="Add operator notes..."></textarea>
          <button id="saveNotes" type="button" class="btn btn-primary">Save Notes</button>
        </div>
        <div class="modal-section">
          <h4>Quick Selfie</h4>
          <div class="selfie-preview" id="selfiePreview">
            <p>No selfie available for this receipt.</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const PIN = "1234";
    const loginBtn = document.getElementById("loginBtn");
    const dashboard = document.getElementById("dashboard");
    const exportBtn = document.getElementById("exportCsv");
    const dateFilters = document.getElementById("dateFilters");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const clearDateFiltersBtn = document.getElementById("clearDateFilters");
    const modalBackdrop = document.getElementById("receiptModal");
    const modalCloseBtn = document.getElementById("modalClose");
    const modalTitle = document.getElementById("modalTitle");
    const modalProgress = document.getElementById("modalProgress");
    const modalNotes = document.getElementById("modalNotes");
    const saveNotesBtn = document.getElementById("saveNotes");
    const selfiePreview = document.getElementById("selfiePreview");
    const modalPricingSection = document.getElementById("modalPricingSection");
    const modalPricing = document.getElementById("modalPricing");

    const dateFormatter = new Intl.DateTimeFormat('en-US', {
      month: 'short',
      day: '2-digit',
      year: 'numeric'
    });

    const STATUS_ENTRIES = [
      { label: 'Paid', key: 'paid' },
      { label: 'Email Sent', key: 'emailed' },
      { label: 'Printed', key: 'printed' },
      { label: 'Picked Up', key: 'pickedUp' },
      { label: 'Photo Taken', key: 'photoTaken' }
    ];

    const PRICING_FALLBACKS = {
      printFee: 5,
      emailFee: 3,
      multiBackgroundFee: 10,
      extraSceneFee: 5
    };

    let recordsCache = [];
    let operatorMeta = {};
    let activeRecordId = null;

    loginBtn.addEventListener("click", () => {
      const input = document.getElementById("pin").value;
      if (input === PIN) {
        dashboard.style.display = "block";
        exportBtn.style.display = "inline-flex";
        if (dateFilters) {
          dateFilters.style.display = "flex";
          updateClearDateFiltersState();
        }
        loadRecords();
      } else {
        alert("Invalid PIN");
      }
    });

    [startDateInput, endDateInput].forEach((input) => {
      if (!input) return;
      input.addEventListener('input', () => {
        applyFilters();
      });
    });

    if (clearDateFiltersBtn) {
      clearDateFiltersBtn.addEventListener('click', () => {
        if (startDateInput) startDateInput.value = '';
        if (endDateInput) endDateInput.value = '';
        applyFilters();
      });
    }

    exportBtn.addEventListener("click", () => {
      const rows = Array.from(document.querySelectorAll('#recordsTable tbody tr'));
      const headers = ["Customer #","Date","Name","Payment","Emails","Prints","Photo ID","Status"];
      const csv = [headers.join(',')];
      rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td'));
        const statusCell = row.querySelector('.status-actions');
        const statusButtons = statusCell ? Array.from(statusCell.querySelectorAll('button')) : [];
        const statusLabels = statusButtons
          .map(btn => `${btn.dataset.action}:${btn.classList.contains('completed') ? 'done' : 'pending'}`)
          .join('|');
        const values = [
          cells[0].textContent.trim(),
          cells[1].textContent.trim(),
          cells[2].textContent.trim(),
          cells[3].textContent.trim(),
          cells[4].textContent.trim(),
          cells[5].textContent.trim(),
          cells[6].textContent.trim(),
          statusLabels
        ];
        csv.push(values.join(','));
      });
      const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'records.csv';
      link.click();
      setTimeout(() => URL.revokeObjectURL(link.href), 1000);
    });

    async function loadRecords() {
      let data = [];
      try {
        const res = await fetch('records.json');
        if (!res.ok) {
          throw new Error('Missing records file');
        }
        data = await res.json();
      } catch (error) {
        const stored = JSON.parse(localStorage.getItem('records') || '[]');
        data = stored;
      }
      operatorMeta = loadOperatorMeta();
      recordsCache = mergeRecordsWithMeta(data);
      applyFilters();
    }

    function renderRecords(data) {
      const tbody = document.querySelector('#recordsTable tbody');
      tbody.innerHTML = data.map((record, index) => {
        const id = record.internalId || getRecordId(record, index);
        const emails = Array.isArray(record.emails) && record.emails.length ? record.emails.join(' | ') : '—';
        const recordDate = getRecordDate(record);
        const formattedDate = recordDate ? dateFormatter.format(recordDate) : '—';
        return `
          <tr data-id="${id}">
            <td>${record.customerNumber || record.photoID || ''}</td>
            <td>${formattedDate}</td>
            <td>${record.name || ''}</td>
            <td>${record.payment || ''}</td>
            <td>${emails}</td>
            <td>${record.prints ?? ''}</td>
            <td>${record.photoID || record.customerNumber || ''}</td>
            <td class="status-actions">
              ${renderStatusButtons(record, id)}
            </td>
            <td>
              <button class="btn btn-secondary details-btn" data-id="${id}">View Receipt</button>
            </td>
          </tr>`;
      }).join('');
      attachStatusListeners();
      attachReceiptListeners();
    }

    function renderStatusButtons(record, recordId) {
      const status = record.status || {};
      return STATUS_ENTRIES.map(({ label, key }) => {
        const completed = Boolean(status[key]);
        return `<button data-action="${key}" data-id="${recordId}" class="btn btn-status ${completed ? 'completed is-complete' : ''}">${label}</button>`;
      }).join('');
    }

    function attachStatusListeners() {
      document.querySelectorAll('.status-actions button').forEach(button => {
        button.addEventListener('click', () => {
          button.classList.toggle('completed');
          button.classList.toggle('is-complete');
          const id = button.dataset.id;
          const action = button.dataset.action;
          const record = recordsCache.find(item => getRecordId(item) === id);
          if (!record) return;
          record.status = record.status || {};
          record.status[action] = button.classList.contains('completed');
          operatorMeta[id] = operatorMeta[id] || {};
          operatorMeta[id].status = { ...record.status };
          saveOperatorMeta();
          if (activeRecordId === id) {
            renderModalProgress(record);
          }
        });
      });
    }

    function attachReceiptListeners() {
      document.querySelectorAll('.details-btn').forEach(button => {
        button.addEventListener('click', () => {
          const id = button.dataset.id;
          openReceiptModal(id);
        });
      });
    }

    function openReceiptModal(recordId) {
      const record = recordsCache.find(item => getRecordId(item) === recordId);
      if (!record) return;
      activeRecordId = recordId;
      modalTitle.textContent = record.name ? `${record.name} (${recordId})` : `Receipt ${recordId}`;
      renderModalProgress(record);
      renderModalPricing(record);
      modalNotes.value = record.notes || '';
      renderSelfiePreview(record);
      modalBackdrop.classList.add('visible');
      modalBackdrop.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      saveNotesBtn.textContent = 'Save Notes';
      saveNotesBtn.disabled = false;
      setTimeout(() => modalNotes.focus(), 0);
    }

    function closeReceiptModal() {
      modalBackdrop.classList.remove('visible');
      modalBackdrop.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      activeRecordId = null;
    }

    function renderModalProgress(record) {
      modalProgress.innerHTML = STATUS_ENTRIES.map(({ label, key }) => {
        const completed = Boolean(record.status && record.status[key]);
        const indicator = completed ? '✓' : '';
        return `<li class="${completed ? 'completed' : ''}"><span class="status-indicator">${indicator}</span><span>${label}</span></li>`;
      }).join('');
    }

    function renderSelfiePreview(record) {
      if (record.selfieData) {
        selfiePreview.innerHTML = `<img src="${record.selfieData}" alt="Quick selfie for ${record.name || record.photoID || 'customer'}" />`;
      } else {
        selfiePreview.innerHTML = '<p>No selfie available for this receipt.</p>';
      }
    }

    function renderModalPricing(record) {
      if (!modalPricing || !modalPricingSection) {
        return;
      }
      const breakdown = buildPricingBreakdownData(record);
      if (!breakdown) {
        modalPricing.innerHTML = '<p class="price-breakdown-empty">No pricing details recorded.</p>';
        return;
      }
      modalPricing.innerHTML = buildPriceBreakdownMarkupFromData(breakdown);
    }

    function buildPricingBreakdownData(record) {
      if (!record || !record.charges) {
        return null;
      }
      const charges = record.charges;
      const currency = charges.currency || 'USD';
      const prints = Number(record.prints ?? charges.prints ?? 0);
      const emails = Number(record.emailCount ?? charges.emails ?? 0);
      const sceneCount = Number(charges.sceneCount ?? record.sceneCount ?? 0);
      const includedScenes = Number(charges.includedScenes ?? record.includedScenes ?? 0);
      const extraSceneCount = Number(charges.extraSceneCount ?? record.extraSceneCount ?? 0);
      const extraSceneFee = Number(charges.extraSceneFee ?? PRICING_FALLBACKS.extraSceneFee);
      const perPrintFee = Number(charges.perPrintFee ?? PRICING_FALLBACKS.printFee);
      const perEmailFee = Number(charges.perEmailFee ?? PRICING_FALLBACKS.emailFee);
      const baseAmount = Number(charges.basePrice || 0);
      const multiAmount = Number(charges.multiBackgroundCost || 0);
      const multiFee = Number(charges.multiBackgroundFee ?? PRICING_FALLBACKS.multiBackgroundFee);
      const multiSelected = multiAmount > 0 || Boolean(record.multipleBackgrounds);
      const sceneCost = Number(charges.sceneCost || 0);
      const printCost = Number(charges.printCost || 0);
      const emailCost = Number(charges.emailCost || 0);

      const baseDetail = includedScenes > 0
        ? `${includedScenes} scene${includedScenes === 1 ? '' : 's'} included`
        : 'No scenes included';
      const multiDetail = multiSelected
        ? `Selected (${formatCurrencyLocal(multiFee, currency)})`
        : `Not selected (${formatCurrencyLocal(multiFee, currency)})`;
      const sceneDetail = extraSceneCount > 0
        ? `${extraSceneCount} extra × ${formatCurrencyLocal(extraSceneFee, currency)}`
        : '0 extra scenes';
      const printDetail = `${prints} × ${formatCurrencyLocal(perPrintFee, currency)}`;
      const emailDetail = `${emails} × ${formatCurrencyLocal(perEmailFee, currency)}`;

      return {
        currency,
        total: Number(charges.total || 0),
        items: [
          { label: 'Base', amount: baseAmount, detail: baseDetail },
          { label: 'Multi-background', amount: multiAmount, detail: multiDetail },
          { label: 'Scenes (extra)', amount: sceneCost, detail: sceneDetail },
          { label: 'Prints (extra)', amount: printCost, detail: printDetail },
          { label: 'Emails (extra)', amount: emailCost, detail: emailDetail }
        ]
      };
    }

    function buildPriceBreakdownMarkupFromData(breakdown) {
      if (!breakdown || !Array.isArray(breakdown.items)) {
        return '';
      }
      const lines = breakdown.items.map(item =>
        priceBreakdownLine(item.label, item.amount, breakdown.currency, { detail: item.detail })
      );
      lines.push(priceBreakdownLine('Total', breakdown.total, breakdown.currency, { isTotal: true }));
      return `<div class="price-breakdown"><p class="price-breakdown-label">Price breakdown:</p><ul>${lines.join('')}</ul></div>`;
    }

    function priceBreakdownLine(label, amount, currency, options = {}) {
      const { detail = '', isTotal = false } = options;
      const formattedAmount = formatCurrencyLocal(Number(amount || 0), currency);
      const classNames = ['price-breakdown-line'];
      if (isTotal) {
        classNames.push('total');
      }
      const detailMarkup = detail ? ` <span class="price-breakdown-detail">${detail}</span>` : '';
      return `<li class="${classNames.join(' ')}"><span class="price-breakdown-line-label">${label}${detailMarkup}</span><span class="price-breakdown-amount">${formattedAmount}</span></li>`;
    }

    function formatCurrencyLocal(amount, currency) {
      try {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(amount);
      } catch (error) {
        return `$${Number(amount || 0).toFixed(2)}`;
      }
    }

    function loadOperatorMeta() {
      try {
        return JSON.parse(localStorage.getItem('operatorMeta') || '{}');
      } catch (error) {
        console.warn('Unable to parse operator metadata', error);
        return {};
      }
    }

    function saveOperatorMeta() {
      localStorage.setItem('operatorMeta', JSON.stringify(operatorMeta));
    }

    function mergeRecordsWithMeta(data) {
      return data.map((record, index) => {
        const id = getRecordId(record, index);
        const meta = operatorMeta[id] || {};
        return {
          ...record,
          internalId: id,
          status: { ...(record.status || {}), ...(meta.status || {}) },
          notes: meta.notes ?? record.notes ?? '',
          selfieData: record.selfieData || null
        };
      });
    }

    function getRecordId(record, index) {
      if (record && record.internalId) {
        return String(record.internalId);
      }
      const fallbackIndex = typeof index === 'number' ? `record-${index}` : '';
      const derived = record ? (record.photoID || record.customerNumber || record.createdAt || fallbackIndex) : fallbackIndex;
      if (record) {
        record.internalId = String(derived);
      }
      return String(derived);
    }

    modalCloseBtn.addEventListener('click', closeReceiptModal);
    modalBackdrop.addEventListener('click', (event) => {
      if (event.target === modalBackdrop) {
        closeReceiptModal();
      }
    });

    window.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && modalBackdrop.classList.contains('visible')) {
        closeReceiptModal();
      }
    });

    saveNotesBtn.addEventListener('click', () => {
      if (!activeRecordId) return;
      const record = recordsCache.find(item => getRecordId(item) === activeRecordId);
      if (!record) return;
      const notes = modalNotes.value.trim();
      record.notes = notes;
      operatorMeta[activeRecordId] = operatorMeta[activeRecordId] || {};
      operatorMeta[activeRecordId].notes = notes;
      saveOperatorMeta();
      saveNotesBtn.textContent = 'Notes Saved';
      saveNotesBtn.disabled = true;
      setTimeout(() => {
        saveNotesBtn.textContent = 'Save Notes';
        saveNotesBtn.disabled = false;
      }, 1200);
    });

    function applyFilters() {
      const filtered = getFilteredRecords();
      renderRecords(filtered);
      updateClearDateFiltersState();
    }

    function getFilteredRecords() {
      if (!Array.isArray(recordsCache) || recordsCache.length === 0) {
        return [];
      }
      const startDate = parseDateInput(startDateInput ? startDateInput.value : '', 'start');
      const endDate = parseDateInput(endDateInput ? endDateInput.value : '', 'end');
      if (!startDate && !endDate) {
        return [...recordsCache];
      }
      return recordsCache.filter((record) => recordMatchesDateRange(record, startDate, endDate));
    }

    function parseDateInput(value, bound) {
      if (!value) return null;
      const isoValue = bound === 'end' ? `${value}T23:59:59.999` : `${value}T00:00:00.000`;
      const parsed = new Date(isoValue);
      return Number.isNaN(parsed.getTime()) ? null : parsed;
    }

    function recordMatchesDateRange(record, startDate, endDate) {
      if (!startDate && !endDate) return true;
      const recordDate = getRecordDate(record);
      if (!recordDate) {
        return false;
      }
      if (startDate && recordDate < startDate) {
        return false;
      }
      if (endDate && recordDate > endDate) {
        return false;
      }
      return true;
    }

    function getRecordDate(record) {
      if (!record) return null;
      if (record.createdAt) {
        const created = new Date(record.createdAt);
        if (!Number.isNaN(created.getTime())) {
          return created;
        }
      }
      if (record.date) {
        const fromDate = new Date(record.date);
        if (!Number.isNaN(fromDate.getTime())) {
          return fromDate;
        }
      }
      return null;
    }

    function updateClearDateFiltersState() {
      if (!clearDateFiltersBtn) return;
      const hasValue = Boolean((startDateInput && startDateInput.value) || (endDateInput && endDateInput.value));
      clearDateFiltersBtn.disabled = !hasValue;
    }
  </script>
</body>
</html>
